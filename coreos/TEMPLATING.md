# Butane Template Workflow - Secure Secrets + Single Source

This guide describes the **recommended workflow** using template-based Butane configs.

## Benefits

✅ **One template** instead of 3+ separate files
✅ **Secrets not in Git** - clean separation
✅ **Reproducible** - easy regeneration
✅ **Fewer errors** - single source of truth

---

## Quick Start

### 1. Create Secrets

```bash
cd coreos/

# Copy the template
cp secrets.env.example secrets.env

# Edit secrets.env
nano secrets.env
```

**Fill in `secrets.env`:**

```bash
# SSH Public Key
SSH_PUBLIC_KEY='ssh-rsa AAAAB3... user@host'

# Generate password hash:
mkpasswd -m sha-512
# Then enter hash:
PASSWORD_HASH='$6$rounds=4096$...'

# JOIN_TOKEN comes later (after bootstrap)
JOIN_TOKEN=''
```

### 2. Generate Bootstrap Config

```bash
# Generates only host03 (bootstrap node)
./generate-configs.sh

# Result: generated/fcos-host03-bootstrap.bu
```

### 3. Create Ignition & Burn USB

```bash
# Convert Butane → Ignition
butane --strict --pretty generated/fcos-host03-bootstrap.bu > host03.ign

# Create USB
sudo coreos-installer install /dev/sdX \
  --image-file fedora-coreos-*.iso \
  --ignition-file host03.ign
```

### 4. Boot host03 & Get Join Token

```bash
# After installation & boot:
ssh core@10.0.100.103

# Get token
sudo cat /var/lib/rancher/rke2/server/node-token
# Example: K10abc123def456ghi789jkl012mno345pqr678stu901vwx234yz::server:a1b2c3d4e5f6
```

### 5. Add Join Token & Generate Join Configs

```bash
# Back on workstation
cd coreos/

# Add token to secrets.env
nano secrets.env
# JOIN_TOKEN='K10abc123...'

# Now generate ALL configs (host01, host02, host03)
./generate-configs.sh
```

**Result:**
```
generated/
├── fcos-host01-join.bu
├── fcos-host02-join.bu
└── fcos-host03-bootstrap.bu
```

### 6. Install Join Nodes

```bash
# host01
butane --strict --pretty generated/fcos-host01-join.bu > host01.ign
sudo coreos-installer install /dev/sdX --image-file fcos.iso --ignition-file host01.ign

# host02
butane --strict --pretty generated/fcos-host02-join.bu > host02.ign
sudo coreos-installer install /dev/sdX --image-file fcos.iso --ignition-file host02.ign
```

---

## Customizing the Template

The template is located in `fcos-template.bu` and is version-controlled in Git.

**To make changes to the cluster (e.g., new VLANs, different network config):**

1. Edit `fcos-template.bu`
2. Run `./generate-configs.sh`
3. Create new Ignition files
4. Reinstall nodes

**Variables in the template:**

```yaml
{{HOSTNAME}}           # host01, host02, host03
{{NODE_IP}}            # 10.0.100.101, .102, .103
{{SSH_PUBLIC_KEY}}     # From secrets.env
{{PASSWORD_HASH}}      # From secrets.env
{{JOIN_TOKEN}}         # From secrets.env (join nodes only)
{{RKE2_CONFIG}}        # Generated by script (bootstrap vs join)
{{POST_INSTALL_SCRIPT}} # Generated by script
```

---

## Security

### What is NOT committed to Git:

✅ `secrets.env` - contains SSH keys, passwords, tokens
✅ `generated/*.bu` - contains embedded secrets
✅ `*.ign` - Ignition files (compiled configs)

### What IS committed to Git:

✅ `fcos-template.bu` - template without secrets
✅ `generate-configs.sh` - generator script
✅ `secrets.env.example` - template with placeholders
✅ `.gitignore` - protection against accidental commits

### Additional Protection

Check that no secrets are committed:

```bash
# Before each commit:
git status

# These files should NEVER appear:
# - secrets.env
# - generated/
# - *.ign

# Optional: Create pre-commit hook
cat > .git/hooks/pre-commit << 'EOF'
#!/bin/bash
if git diff --cached --name-only | grep -E 'secrets.env|\.ign$|^generated/'; then
  echo "❌ Error: Trying to commit secrets!"
  exit 1
fi
EOF
chmod +x .git/hooks/pre-commit
```

---

## Alternative: SOPS (for Teams)

For team environments with shared secrets:

### SOPS + Age Encryption

```bash
# Generate age key
age-keygen -o age.key

# Share public key with team
cat age.key | grep "public key:"

# Encrypt secrets.env
sops --age <PUBLIC_KEY> --encrypt secrets.env > secrets.env.enc

# Commit to Git:
git add secrets.env.enc

# Other team members decrypt:
export SOPS_AGE_KEY_FILE=~/age.key
sops --decrypt secrets.env.enc > secrets.env
```

**Advantage:** Secrets can be safely stored in Git (encrypted)

---

## Workflow Comparison

| Aspect | Old (3 separate files) | New (Template + Generator) |
|--------|--------------------------|----------------------------|
| Files | 3x .bu with duplicates | 1x template |
| Secrets | In every file | Separate secrets.env |
| Updates | Edit 3x | Edit template once |
| Git | Manually remove secrets | Automatically excluded |
| Errors | Inconsistencies possible | Single source of truth |
| Regenerate | Manual | `./generate-configs.sh` |

---

## Troubleshooting

### "secrets.env not found"

```bash
cp secrets.env.example secrets.env
nano secrets.env
```

### "JOIN_TOKEN not set"

Normal on first run! First install bootstrap, then get token and regenerate.

### Butane Conversion Error

```bash
# Check syntax
butane --strict generated/fcos-host03-bootstrap.bu

# Common errors:
# - Incorrect YAML indentation
# - Variables not replaced ({{...}} still visible)
```

### Generated configs are empty

```bash
# Check script output
./generate-configs.sh

# Check permissions
chmod +x generate-configs.sh
```

---

## Backup & Recovery

### Backing up Secrets

```bash
# Local backup (outside Git)
cp secrets.env ~/secure-backup/k8s-homelab-secrets.env

# Or encrypted:
gpg --encrypt --recipient your@email.com secrets.env
# → secrets.env.gpg (can be in Git)
```

### Regenerate Join Token

If token expired or lost:

```bash
# On bootstrap node (host03):
sudo kubeadm token create --print-join-command
# or
sudo cat /var/lib/rancher/rke2/server/node-token
```

---

## Migration from Old Configs

If you already have `fcos-host0X-*.bu` files:

```bash
# 1. Extract secrets
grep "ssh_authorized_keys" fcos-host03-bootstrap.bu
grep "password_hash" fcos-host03-bootstrap.bu
grep "token:" fcos-host01-join.bu

# 2. Add to secrets.env
nano secrets.env

# 3. Archive old files
mkdir -p archive
mv fcos-host0*.bu archive/

# 4. Generate new configs
./generate-configs.sh

# 5. Compare (optional)
diff archive/fcos-host03-bootstrap.bu generated/fcos-host03-bootstrap.bu
```

---

## Summary

**Workflow:**
1. Create `secrets.env` (one-time)
2. Bootstrap: `./generate-configs.sh` → host03 only
3. Install host03 & get token
4. Add token to `secrets.env`
5. Join nodes: `./generate-configs.sh` → all nodes
6. Install host01 & host02

**Security:**
- Secrets never in Git
- `.gitignore` protects automatically
- Optional: SOPS for team environments

**Maintenance:**
- Modify template → regenerate → reinstall
- Single source of truth
- No manual duplicates

---

**Recommendation:** Use this workflow for all future installations!
