variant: fcos
version: 1.5.0

# Fedora CoreOS Template for RKE2 Kubernetes Cluster
# Variables to replace: {{HOSTNAME}}, {{NODE_IP}}, {{IS_BOOTSTRAP}}, {{JOIN_TOKEN}}

passwd:
  users:
    - name: core
      password_hash: "{{PASSWORD_HASH}}"
      ssh_authorized_keys:
        - "{{SSH_PUBLIC_KEY}}"
      groups:
        - wheel
        - sudo
        - docker

storage:
  files:
    # Hostname
    - path: /etc/hostname
      mode: 0644
      contents:
        inline: {{HOSTNAME}}

    # Kernel modules
    - path: /etc/modules-load.d/kubernetes.conf
      mode: 0644
      contents:
        inline: |
          overlay
          br_netfilter
          iptable_nat
          ip_vs
          ip_vs_rr
          ip_vs_wrr
          ip_vs_sh
          nf_conntrack
          vhost_net
          vhost_vsock
          vxlan
          geneve
          ip_tunnel

    # Sysctl configuration
    - path: /etc/sysctl.d/99-kubernetes.conf
      mode: 0644
      contents:
        inline: |
          net.ipv4.ip_forward = 1
          net.ipv6.conf.all.forwarding = 1
          net.bridge.bridge-nf-call-iptables = 1
          net.bridge.bridge-nf-call-ip6tables = 1
          net.ipv4.tcp_slow_start_after_idle = 0
          net.core.rmem_max = 134217728
          net.core.wmem_max = 134217728
          net.ipv4.tcp_rmem = 4096 87380 67108864
          net.ipv4.tcp_wmem = 4096 65536 67108864
          net.netfilter.nf_conntrack_max = 1000000
          net.netfilter.nf_conntrack_tcp_timeout_established = 86400
          net.ipv4.neigh.default.gc_thresh1 = 80000
          net.ipv4.neigh.default.gc_thresh2 = 90000
          net.ipv4.neigh.default.gc_thresh3 = 100000
          fs.inotify.max_user_instances = 8192
          fs.inotify.max_user_watches = 524288
          fs.file-max = 2097152
          vm.max_map_count = 262144

    # Disable auto-updates
    - path: /etc/zincati/config.d/90-disable-auto-updates.toml
      mode: 0644
      contents:
        inline: |
          [updates]
          enabled = false

    # NetworkManager: LACP Bond
    - path: /etc/NetworkManager/system-connections/bond0.nmconnection
      mode: 0600
      contents:
        inline: |
          [connection]
          id=bond0
          type=bond
          interface-name=bond0
          autoconnect=yes
          autoconnect-priority=10
          autoconnect-slaves=1
          wait-device-timeout=30000

          [bond]
          mode=802.3ad
          miimon=100
          lacp_rate=fast
          xmit_hash_policy=layer3+4

          [ipv4]
          method=disabled

          [ipv6]
          method=disabled

    # NetworkManager: Physical Interface 1
    - path: /etc/NetworkManager/system-connections/enp1s0.nmconnection
      mode: 0600
      contents:
        inline: |
          [connection]
          id=enp1s0
          type=ethernet
          interface-name=enp1s0
          master=bond0
          slave-type=bond
          autoconnect=yes
          autoconnect-priority=5

    # NetworkManager: Physical Interface 2
    - path: /etc/NetworkManager/system-connections/enp1s0d1.nmconnection
      mode: 0600
      contents:
        inline: |
          [connection]
          id=enp1s0d1
          type=ethernet
          interface-name=enp1s0d1
          master=bond0
          slave-type=bond
          autoconnect=yes
          autoconnect-priority=5

    # NetworkManager: VLAN 100 (Cluster Network)
    - path: /etc/NetworkManager/system-connections/vlan100.nmconnection
      mode: 0600
      contents:
        inline: |
          [connection]
          id=vlan100
          type=vlan
          interface-name=vlan100
          autoconnect=yes
          autoconnect-priority=1

          [vlan]
          id=100
          parent=bond0

          [ipv4]
          method=manual
          address1={{NODE_IP}}/24

          [ipv6]
          method=disabled

    # NetworkManager: Management Interface (eno1)
    - path: /etc/NetworkManager/system-connections/eno1.nmconnection
      mode: 0600
      contents:
        inline: |
          [connection]
          id=eno1
          type=ethernet
          interface-name=eno1
          autoconnect=yes

          [ipv4]
          method=auto

          [ipv6]
          method=disabled

    # RKE2 Configuration
    - path: /etc/rancher/rke2/config.yaml
      mode: 0644
      contents:
        inline: |
          {{RKE2_CONFIG}}

    # Cilium HelmChartConfig
    - path: /var/lib/rancher/rke2/server/manifests/rke2-cilium-config.yaml
      mode: 0644
      contents:
        inline: |
          ---
          apiVersion: helm.cattle.io/v1
          kind: HelmChartConfig
          metadata:
            name: rke2-cilium
            namespace: kube-system
          spec:
            valuesContent: |-
              ipam:
                mode: kubernetes
              kubeProxyReplacement: true
              k8sServiceHost: 127.0.0.1
              k8sServicePort: 6443
              operator:
                replicas: 1
              hubble:
                enabled: true
                relay:
                  enabled: true
                ui:
                  enabled: true
                metrics:
                  enabled:
                    - dns
                    - drop
                    - tcp
                    - flow
                    - icmp
                    - http
              bgpControlPlane:
                enabled: true
              externalIPs:
                enabled: true
              loadBalancer:
                mode: hybrid
              enableIPv4Masquerade: true
              routingMode: native
              autoDirectNodeRoutes: true
              ipv4NativeRoutingCIDR: 10.1.0.0/16
              bpf:
                masquerade: true

    # RKE2 install script
    - path: /usr/local/bin/install-rke2.sh
      mode: 0755
      contents:
        inline: |
          #!/bin/bash
          set -e
          echo "Installing RKE2..."
          curl -sfL https://get.rke2.io | sh -
          ln -sf /var/lib/rancher/rke2/bin/kubectl /usr/local/bin/kubectl
          mkdir -p /home/core/.kube
          echo "RKE2 installation complete"

    # Post-install script
    - path: /usr/local/bin/rke2-post-install.sh
      mode: 0755
      contents:
        inline: |
          {{POST_INSTALL_SCRIPT}}

systemd:
  units:
    - name: systemd-modules-load.service
      enabled: true
    - name: systemd-sysctl.service
      enabled: true
    - name: swap.target
      mask: true
    - name: chronyd.service
      enabled: true

    # RKE2 install service
    - name: rke2-install.service
      enabled: true
      contents: |
        [Unit]
        Description=Install RKE2
        After=network-online.target
        Wants=network-online.target
        ConditionPathExists=!/usr/local/bin/rke2

        [Service]
        Type=oneshot
        RemainAfterExit=yes
        ExecStart=/usr/local/bin/install-rke2.sh

        [Install]
        WantedBy=multi-user.target

    # RKE2 Server service
    - name: rke2-server.service
      enabled: true
      contents: |
        [Unit]
        Description=RKE2 Server
        After=network-online.target rke2-install.service
        Wants=network-online.target
        Requires=rke2-install.service

        [Service]
        Type=notify
        EnvironmentFile=-/etc/default/rke2-server
        KillMode=process
        Delegate=yes
        LimitNOFILE=1048576
        LimitNPROC=infinity
        LimitCORE=infinity
        TasksMax=infinity
        TimeoutStartSec=0
        Restart=always
        RestartSec=5s
        ExecStart=/usr/local/bin/rke2 server

        [Install]
        WantedBy=multi-user.target

    # Post-install service
    - name: rke2-post-install.service
      enabled: true
      contents: |
        [Unit]
        Description=RKE2 Post-Installation Tasks
        After=rke2-server.service
        Requires=rke2-server.service

        [Service]
        Type=oneshot
        RemainAfterExit=yes
        ExecStart=/usr/local/bin/rke2-post-install.sh

        [Install]
        WantedBy=multi-user.target
