# Talos Inline Manifests

This directory contains **auto-generated** manifests that are embedded into the Talos controlplane configuration.

## What's in here?

These files are generated by `../scripts/generate-inline-manifests.sh`:

- `cilium-inline.yaml` - Cilium CNI (full featured, generated from Helm chart)
- `argocd-inline.yaml` - ArgoCD GitOps operator (generated from Helm chart)
- `root-app-inline.yaml` - Root-of-roots App (copy of ../../bootstrap/root-app.yaml)

## When are they generated?

Automatically when you run:

```bash
./scripts/build-talos-configs.sh
```

The build script:
1. Calls `generate-inline-manifests.sh`
2. Embeds these manifests into `configs/controlplane-host03.yaml`
3. These manifests deploy automatically when you run `talosctl bootstrap`

## Should I commit them?

**No!** These files are:
- Auto-generated
- Large (thousands of lines)
- Gitignored (see `../../.gitignore`)

**Do commit:**
- `../../infrastructure/00-cilium/cilium-values.yaml` (source of truth for Cilium config)
- Generation scripts

## How it works

```
Source Files:
  infrastructure/00-cilium/cilium-values.yaml
  bootstrap/root-app.yaml

     ↓ (generate-inline-manifests.sh)

Generated:
  talos/manifests/cilium-inline.yaml
  talos/manifests/argocd-inline.yaml
  talos/manifests/root-app-inline.yaml

     ↓ (build-talos-configs.sh embeds them)

Result:
  talos/configs/controlplane-host03.yaml
    └── cluster.inlineManifests
          ├── cilium
          ├── argocd
          └── root-app

     ↓ (talosctl bootstrap deploys them)

Running Cluster:
  ✅ Cilium CNI (kube-system namespace)
  ✅ ArgoCD (argocd namespace)
  ✅ Root App (argocd namespace)
```

## Updating

To update Cilium or ArgoCD configuration:

1. **Edit the source:**
   - For Cilium: `../../infrastructure/00-cilium/cilium-values.yaml`
   - For ArgoCD: `generate-inline-manifests.sh` (Helm values)

2. **Regenerate:**
   ```bash
   ./scripts/build-talos-configs.sh
   ```

3. **Apply changes:**
   ```bash
   # Update existing cluster
   talosctl apply-config --nodes 10.0.100.103 --file configs/host03.yaml

   # Wait for rollout
   kubectl rollout restart -n kube-system daemonset/cilium
   kubectl rollout restart -n argocd deployment/argocd-server
   ```

## Troubleshooting

### Manifests not generated

```bash
# Check if helm is installed
helm version

# Manually run generation
./scripts/generate-inline-manifests.sh
```

### Wrong Cilium configuration

Make sure you edited:
- `../../infrastructure/00-cilium/cilium-values.yaml` (source file)

NOT:
- `cilium-inline.yaml` (generated, will be overwritten!)

### ArgoCD not adopting Cilium

Check that `cilium-values.yaml` matches what's embedded in the inline manifest.
The ArgoCD Application in `../../infrastructure/00-cilium/cilium-helm.yaml`
should have identical values to prevent ArgoCD from updating Cilium.
